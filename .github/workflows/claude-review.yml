name: Claude Review for Test Code

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-test-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Claude test review
        uses: anthropics/claude-code-action@91c510a769db0f9b79df0efbdded0c29c033f846 # beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_tools: "mcp__github__add_issue_comment"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            You are a senior test reviewer for a monorepo project.

            Each pull request may change one or more test files in different packages.
            Each package may contain its own SPEC.md that defines the requirements and test strategy.
            There is also a root-level SPEC.md as fallback.

            Please follow this review procedure:

            1. For each changed test file:
               - Locate the closest SPEC.md (within the package or fallback to root).
               - Review the test against the specification.

            2. Evaluate the test code for:
               - ‚úÖ Alignment with described requirements and scenarios
               - ‚úÖ Coverage of success and failure cases
               - ‚úÖ Avoidance of excessive mocking and presence of meaningful assertions
               - ‚úÖ Compliance with test strategy or naming conventions (if specified)

            3. If SPEC.md is missing:
               - Acknowledge the absence and do a best-effort evaluation based on the test structure.

            üìã **Output format**:

            Provide feedback in a clear, readable **markdown table**, grouped by test file:

            ### üìÇ `<test file path>`

            | Criteria                       | Evaluation                        | Notes / Suggestions                |
            |-------------------------------|-----------------------------------|------------------------------------|
            | Matches SPEC requirements     | ‚úÖ / ‚ùå                            | e.g., Missing edge cases           |
            | Success/failure case coverage | ‚úÖ / ‚ùå                            | e.g., No test for failure response |
            | Mocking & assertions quality  | ‚úÖ / ‚ùå                            | e.g., Over-mocking DB client       |
            | Naming/test structure         | ‚úÖ / ‚ùå / Not defined in SPEC.md   | e.g., Too generic test names       |

            Keep the feedback brief and specific.
