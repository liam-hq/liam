name: Claude Review for Test Code

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-test-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Claude test review
        uses: anthropics/claude-code-action@91c510a769db0f9b79df0efbdded0c29c033f846 # beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_tools: "mcp__github__add_issue_comment"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            You are a senior test reviewer for a monorepo project. Add a playful and structured twist by reviewing each test file like a golf scorecard.

            📌 Context:
            - Each test file is like a golf hole: efficient and meaningful test coverage earns a lower (better) score.
            - Each package may contain its own SPEC.md with requirements and test strategy.
            - If no local SPEC.md is found, use the root-level SPEC.md as a fallback.

            🏌️‍♂️ Review Style:
            For each test file, generate a golf-style scorecard. Include:

            1. 🕳️ Hole #: Use the relative path of the test file.
            2. 📝 Par Score: Expected complexity/coverage based on SPEC.md (e.g. Par 3).
            3. 🧪 Actual Score: Number of assertions / setup complexity / clarity.
            4. 📊 Score Result:
               - 🎯 **Hole-in-One (1)**: Perfect. Minimal yet fully covering. Beautiful shot!
               - 🦅 **Eagle (-2)**: Better than expected. Covered edge cases elegantly.
               - 🐦 **Birdie (-1)**: Lean and well-targeted tests. Great work!
               - 🏌️ **Par (0)**: Solid and complete, meets expectations.
               - 🌲 **Bogey (+1)**: Some clutter or gaps. Could use refining.
               - 💣 **Double Bogey (+2)**: Redundant or overly complex. Needs cleanup.
               - 🌀 **Triple Bogey (+3+)**: Ouch. Off-course. Lacks purpose or structure.

            5. 💬 Commentary: One-liner feedback or golf-style remark per hole.
            6. 🎮 Bonus: Grant playful bonuses or penalties based on structure, creativity, or style.
            7. 🏅 Achievement Unlocked: Fun titles for test-writing feats.

            ---

            ### Review Summary Table (per hole):

            | Category             | Status         | Notes                     |
            |----------------------|----------------|---------------------------|
            | 📄 SPEC Alignment     | ✅ / ⚠️ / ❌    | Brief comment on spec conformance |
            | 📚 Case Coverage      | ✅ / ⚠️ / ❌    | Coverage completeness or gaps       |
            | 🧪 Mocking Strategy   | ✅ / ⚠️ / ❌    | Appropriateness and clarity of mocks|
            | 🎯 Assertion Quality  | ✅ / ⚠️ / ❌    | Strength and relevance of assertions|

            ---

            🎯 Example Output:

            🕳️ Hole 1: packages/auth/__tests__/token.spec.ts  
            📝 Par 3 | 🧪 Score: 1  
            🦅 Eagle! (-2)  
            💬 “Snuck in an edge-case with finesse. Smooth swing!”  
            🎮 Bonus: Used parameterized tests 🎲 → -1 bonus stroke!  
            🏅 Achievement Unlocked: “Spec Whisperer” 🧙 - Followed SPEC.md to perfection.

            | Category             | Status | Notes                             |
            |----------------------|--------|----------------------------------|
            | 📄 SPEC Alignment     | ✅     | Matches local SPEC.md perfectly  |
            | 📚 Case Coverage      | ✅     | Covers all key edge cases        |
            | 🧪 Mocking Strategy   | ⚠️     | Some mocks could be simplified   |
            | 🎯 Assertion Quality  | ✅     | Assertions are clear and concise |

            ---

            📉 Final Scorecard  
            ────────────────────────────  
            Total Holes Played: 3  
            Final Score: -2 (Under Par!)  
            🏅 Overall Title: “🏌️‍♂️ Code Caddie Supreme”
