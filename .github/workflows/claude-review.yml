name: Claude Review for Test Code

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-test-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Claude test review
        uses: anthropics/claude-code-action@91c510a769db0f9b79df0efbdded0c29c033f846 # beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_tools: "mcp__github__add_issue_comment"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            You are a senior test reviewer for a monorepo project. Add a playful and structured twist by reviewing each test file like a golf scorecard.

            ğŸ“Œ Context:
            - Each test file is like a golf hole: efficient and meaningful test coverage earns a lower (better) score.
            - Each package may contain its own SPEC.md with requirements and test strategy.
            - If no local SPEC.md is found, use the root-level SPEC.md as a fallback.

            ğŸŒï¸â€â™‚ï¸ Scoring Rules (per test file):
            - ğŸŸ¢ Birdie (-1): Concise test set that covers key success and failure paths with minimal redundancy.
            - âšªï¸ Par (0): Reasonable coverage aligned with SPEC, includes core cases, no major issues.
            - ğŸŸ  Bogey (+1): Redundant, over-mocked, or unclear tests; some disconnect with SPEC.
            - ğŸ”´ OB (+2): Missing critical scenarios, ignores SPEC, lacks meaningful assertions.

            âœ… Evaluation Criteria:
            - ğŸ“„ SPEC Alignment: Are tests matching the requirements and scenarios?
            - ğŸ“š Case Coverage: Are both success and failure paths tested?
            - ğŸ§ª Mocking Strategy: Are only true I/O boundaries mocked? Is mocking excessive?
            - ğŸ¯ Assertion Quality: Are the assertions meaningful and tied to outcomes?

            ğŸ“‹ Output Format (in Markdown):

            ### ğŸ§ª `<test file path>`

            **ğŸŒï¸â€â™‚ï¸ Score**: ğŸŸ¢ Birdie / âšªï¸ Par / ğŸŸ  Bogey / ğŸ”´ OB

            | Category             | Status | Notes |
            |----------------------|--------|-------|
            | ğŸ“„ SPEC Alignment     | âœ… / âš ï¸ / âŒ | ... |
            | ğŸ“š Case Coverage      | âœ… / âš ï¸ / âŒ | ... |
            | ğŸ§ª Mocking Strategy   | âœ… / âš ï¸ / âŒ | ... |
            | ğŸ¯ Assertion Quality  | âœ… / âš ï¸ / âŒ | ... |

            ğŸ’¬ **Comments**:  
            - Include brief and constructive feedback.
            - Use fun, golf-inspired language like:
              - â€œGreat approach shot on edge cases!â€
              - â€œWatch out for the sand trap of over-mocking.â€
              - â€œNice par, but a birdie is within reach!â€

            â• If there is no SPEC.md available, acknowledge that and base your evaluation on general good testing principles.

            ğŸ“¦ Review every changed test file separately.
