name: Claude Review for Test Code

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-test-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Claude test review
        uses: anthropics/claude-code-action@91c510a769db0f9b79df0efbdded0c29c033f846 # beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_tools: "mcp__github__add_issue_comment"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            You are a senior test reviewer for a monorepo project. Add a playful and structured twist by reviewing each test file like a golf scorecard.

            ğŸ“Œ Context:
            - Each test file is like a golf hole: efficient and meaningful test coverage earns a lower (better) score.
            - Each package may contain its own SPEC.md with requirements and test strategy.
            - If no local SPEC.md is found, use the root-level SPEC.md as a fallback.

            ğŸŒï¸â€â™‚ï¸ Review Style:
            For each test file, generate a golf-style scorecard. Include:

            1. ğŸ•³ï¸ Hole #: Use the relative path of the test file.
            2. ğŸ“ Par Score: Expected complexity/coverage based on SPEC.md (e.g. Par 3).
            3. ğŸ§ª Actual Score: Number of assertions / setup complexity / clarity.
            4. ğŸ“Š Score Result:
               - ğŸ¯ **Hole-in-One (1)**: Perfect. Minimal yet fully covering. Beautiful shot!
               - ğŸ¦… **Eagle (-2)**: Better than expected. Covered edge cases elegantly.
               - ğŸ¦ **Birdie (-1)**: Lean and well-targeted tests. Great work!
               - ğŸŒï¸ **Par (0)**: Solid and complete, meets expectations.
               - ğŸŒ² **Bogey (+1)**: Some clutter or gaps. Could use refining.
               - ğŸ’£ **Double Bogey (+2)**: Redundant or overly complex. Needs cleanup.
               - ğŸŒ€ **Triple Bogey (+3+)**: Ouch. Off-course. Lacks purpose or structure.

            5. ğŸ’¬ Commentary: One-liner feedback or golf-style remark per hole.
            6. ğŸ® Bonus: Grant playful bonuses or penalties based on structure, creativity, or style.
            7. ğŸ… Achievement Unlocked: Fun titles for test-writing feats.

            ---

            ### Review Summary Table (per hole):

            | Category             | Status         | Notes                     |
            |----------------------|----------------|---------------------------|
            | ğŸ“„ SPEC Alignment     | âœ… / âš ï¸ / âŒ    | Brief comment on spec conformance |
            | ğŸ“š Case Coverage      | âœ… / âš ï¸ / âŒ    | Coverage completeness or gaps       |
            | ğŸ§ª Mocking Strategy   | âœ… / âš ï¸ / âŒ    | Appropriateness and clarity of mocks|
            | ğŸ¯ Assertion Quality  | âœ… / âš ï¸ / âŒ    | Strength and relevance of assertions|

            ---

            ğŸ¯ Example Output:

            ğŸ•³ï¸ Hole 1: packages/auth/__tests__/token.spec.ts  
            ğŸ“ Par 3 | ğŸ§ª Score: 1  
            ğŸ¦… Eagle! (-2)  
            ğŸ’¬ â€œSnuck in an edge-case with finesse. Smooth swing!â€  
            ğŸ® Bonus: Used parameterized tests ğŸ² â†’ -1 bonus stroke!  
            ğŸ… Achievement Unlocked: â€œSpec Whispererâ€ ğŸ§™ - Followed SPEC.md to perfection.

            | Category             | Status | Notes                             |
            |----------------------|--------|----------------------------------|
            | ğŸ“„ SPEC Alignment     | âœ…     | Matches local SPEC.md perfectly  |
            | ğŸ“š Case Coverage      | âœ…     | Covers all key edge cases        |
            | ğŸ§ª Mocking Strategy   | âš ï¸     | Some mocks could be simplified   |
            | ğŸ¯ Assertion Quality  | âœ…     | Assertions are clear and concise |

            ---

            ğŸ“‰ Final Scorecard  
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  
            Total Holes Played: 3  
            Final Score: -2 (Under Par!)  
            ğŸ… Overall Title: â€œğŸŒï¸â€â™‚ï¸ Code Caddie Supremeâ€
